# Squid Proxy Configuration with SSL Bump (MITM) Support
# =========================================================

# ============================================
# Network ACLs (Access Control Lists)
# ============================================

# Define local networks that are allowed to use the proxy
acl localnet src 192.168.0.0/16      # Local private network
acl localnet src 10.0.0.0/8          # Local private network
acl localnet src 172.16.0.0/12       # Local private network (optional)
acl localnet src fc00::/7            # IPv6 local private network
acl localnet src fe80::/10           # IPv6 link-local network

# Standard port definitions
acl SSL_ports port 443
acl Safe_ports port 80              # HTTP
acl Safe_ports port 21              # FTP
acl Safe_ports port 443             # HTTPS
acl Safe_ports port 70              # Gopher
acl Safe_ports port 210             # WAIS
acl Safe_ports port 1025-65535      # Unregistered ports
acl Safe_ports port 280             # HTTP-MGMT
acl Safe_ports port 488             # GSS-HTTP
acl Safe_ports port 591             # FileMaker
acl Safe_ports port 777             # Multiling HTTP

# CONNECT method (used for HTTPS)
acl CONNECT method CONNECT

# ACL for SSL certificate validation during fetch
acl intermediate_fetching transaction_initiator certificate-fetching

# ============================================
# Access Rules
# ============================================

# Deny requests to unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# Allow intermediate certificate fetching (required for SSL bump)
http_access allow intermediate_fetching

# Allow localhost manager access
http_access allow localhost manager
http_access deny manager

# Allow access from local networks
http_access allow localnet
http_access allow localhost

# Deny all other access
http_access deny all

# ============================================
# Proxy Port Configuration
# ============================================

# Standard HTTP/HTTPS proxy port without SSL bump
http_port 3128

# SSL bump enabled proxy port
http_port 4128 ssl-bump cert=/etc/squid/ssl/ca-cert.pem key=/etc/squid/ssl/ca-key.pem \
	generate-host-certificates=on dynamic_cert_mem_cache_size=4MB

# Bumped requests have relative URLs, so Squid needs to use reverse proxy mode
# This tells Squid to directly forward bumped HTTPS requests to origin servers
always_direct allow all

# ============================================
# SSL Bump Configuration (MITM for HTTPS)
# ============================================
# Enable SSL bump to intercept and inspect HTTPS traffic

# Allow self-signed and invalid certificates (required for SSL bump with generated CA)
sslproxy_cert_error allow all

# Helper program for generating dynamic certificates
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 4MB
sslcrtd_children 5

# SSL bumping rules - intercept all HTTPS traffic
# Step 1: Peek at the SNI to determine destination
# Then bump to intercept and inspect the traffic
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

# Optional: Sites to NOT intercept (uncomment and customize)
# acl nobump_sites ssl::server_name .bank.com .paypal.com
# ssl_bump splice nobump_sites

# ============================================
# Cache Configuration
# ============================================

# Cache directory: ufs = Unix File System
# Format: cache_dir type directory size(MB) dir1 dir2
cache_dir ufs /var/cache/squid 1000 16 256

# Maximum object size to cache (in MB)
maximum_object_size 50 MB

# Minimum object size to cache (in KB)
minimum_object_size 0 KB

# Memory cache size
cache_mem 256 MB

# Maximum object size in memory (in MB)
maximum_object_size_in_memory 512 KB

# Use Squid defaults for replacement policies

# ============================================
# Logging Configuration
# ============================================

# Access log format and location
access_log /var/log/squid/access.log squid

# Cache log location
cache_log /var/log/squid/cache.log

# Store log location
cache_store_log /var/log/squid/store.log

# Log level (0=none, 1=critical, 2=important, 3=normal, 9=all)
debug_options ALL,1

# Log file rotation (handled externally)
logfile_rotate 10

# ============================================
# Performance Tuning
# ============================================

# Disable core dumps for security
coredump_dir /var/cache/squid

# DNS settings
dns_nameservers 8.8.8.8 8.8.4.4

# Refresh patterns for caching
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# ============================================
# Miscellaneous
# ============================================

# Run Squid helpers and cache as the same user as the SSL DB
cache_effective_user squid
cache_effective_group squid

# Visible hostname
visible_hostname squid-proxy

# Disable via header (for privacy)
via off

# Disable forwarded_for header (for privacy)
forwarded_for off

# Follow X-Forwarded-For header
follow_x_forwarded_for allow all

# HTTP protocol version
request_header_max_size 128 KB
